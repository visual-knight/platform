# Migration `20200406220516-init1`

This migration has been generated by Filtering is added at 4/6/2020, 10:05:16 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "Role" AS ENUM ('CUSTOMER', 'ADMIN');

CREATE TYPE "TestSessionState" AS ENUM ('PENDING', 'UNRESOLVED', 'ACCEPTED', 'DECLINED');

CREATE TABLE "public"."User" (
    "active" boolean  NOT NULL DEFAULT false,
    "apiKey" text  NOT NULL ,
    "createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "email" text  NOT NULL ,
    "forename" text   ,
    "id" text  NOT NULL ,
    "lastname" text   ,
    "password" text  NOT NULL ,
    "role" "Role" NOT NULL DEFAULT 'CUSTOMER',
    "updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."Project" (
    "createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "description" text   ,
    "id" text  NOT NULL ,
    "name" text  NOT NULL ,
    "updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."Test" (
    "createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "id" text  NOT NULL ,
    "name" text  NOT NULL ,
    "projectId" text  NOT NULL ,
    "updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."Variation" (
    "additionalData" text   ,
    "baselineId" text   ,
    "browserName" text  NOT NULL ,
    "createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "deviceName" text  NOT NULL ,
    "id" text  NOT NULL ,
    "testId" text  NOT NULL ,
    "updatedAt" timestamp(3)  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."TestSession" (
    "autoBaseline" boolean  NOT NULL DEFAULT false,
    "createdAt" timestamp(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "diffImageKey" text   ,
    "id" text  NOT NULL ,
    "imageKey" text   ,
    "isSameDimensions" boolean   ,
    "misMatchPercentage" Decimal(65,30)   ,
    "misMatchTolerance" Decimal(65,30)  NOT NULL ,
    "state" "TestSessionState" NOT NULL DEFAULT 'PENDING',
    "stateComment" text   ,
    "updatedAt" timestamp(3)  NOT NULL ,
    "variationId" text  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE UNIQUE INDEX "User.email" ON "public"."User"("email")

CREATE UNIQUE INDEX "User.apiKey" ON "public"."User"("apiKey")

ALTER TABLE "public"."Test" ADD FOREIGN KEY ("projectId")REFERENCES "public"."Project"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Variation" ADD FOREIGN KEY ("testId")REFERENCES "public"."Test"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Variation" ADD FOREIGN KEY ("baselineId")REFERENCES "public"."TestSession"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."TestSession" ADD FOREIGN KEY ("variationId")REFERENCES "public"."Variation"("id") ON DELETE CASCADE  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20200406220516-init1
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,95 @@
+// SQLite / Mysql / Postgres
+datasource db {
+  // https://github.com/prisma/prisma2/blob/master/docs/core/connectors
+  // mysql | sqlite | postgresql
+  provider = "postgresql"
+  url      = env("VK_DATABASE")
+}
+
+generator photon {
+  provider     = "prisma-client-js"
+  binaryTarget = ["native", "linux-glibc-libssl1.0.2"]
+  output       = "../../node_modules/@generated/photonjs"
+}
+
+model User {
+  id        String   @id @default(cuid())
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+
+  email    String  @unique
+  password String
+  lastname String?
+  forename String?
+  active   Boolean @default(false)
+  role     Role    @default(CUSTOMER)
+  apiKey   String  @unique
+}
+
+model Project {
+  id        String   @id @default(cuid())
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+
+  name        String
+  description String?
+  tests       Test[]
+}
+
+model Test {
+  id        String   @id @default(cuid())
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+
+  name       String
+  project    Project @relation(fields: [projectId], references: [id])
+  projectId  String 
+  variations Variation[]
+}
+
+model Variation {
+  id        String   @id @default(cuid())
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+
+  browserName String
+  deviceName  String
+  test        Test   @relation(fields: [testId], references: [id])
+  testId      String
+
+  testSessions   TestSession[]
+  additionalData String?
+  baseline       TestSession?  @relation(name: "VariationBaseline", fields: [baselineId], references: [id])
+  baselineId     String?
+}
+
+model TestSession {
+  id        String   @id @default(cuid())
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+
+  diffImageKey       String?
+  imageKey           String?
+  misMatchPercentage Float?
+  misMatchTolerance  Float
+  isSameDimensions   Boolean?
+  variation          Variation        @relation(fields: [variationId], references: [id])
+  variationId        String
+  state              TestSessionState @default(PENDING)
+  stateChangedByUser User?
+  stateComment       String?
+  autoBaseline       Boolean          @default(false)
+
+}
+
+enum Role {
+  CUSTOMER
+  ADMIN
+}
+
+enum TestSessionState {
+  PENDING
+  UNRESOLVED
+  ACCEPTED
+  DECLINED
+}
```


