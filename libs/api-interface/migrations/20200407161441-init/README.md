# Migration `20200407161441-init`

This migration has been generated by Filtering is added at 4/7/2020, 4:14:41 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
CREATE TYPE "Role" AS ENUM ('CUSTOMER', 'ADMIN');

CREATE TYPE "TestSessionState" AS ENUM ('PENDING', 'UNRESOLVED', 'ACCEPTED', 'DECLINED');

CREATE TABLE "public"."User" (
    "active" boolean  NOT NULL DEFAULT false,
    "apiKey" text  NOT NULL DEFAULT '',
    "createdAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00',
    "email" text  NOT NULL DEFAULT '',
    "forename" text   ,
    "id" text  NOT NULL ,
    "lastname" text   ,
    "password" text  NOT NULL DEFAULT '',
    "role" "Role" NOT NULL DEFAULT 'CUSTOMER',
    "updatedAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00',
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."Project" (
    "createdAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00',
    "description" text   ,
    "id" text  NOT NULL ,
    "name" text  NOT NULL DEFAULT '',
    "updatedAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00',
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."Test" (
    "createdAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00',
    "id" text  NOT NULL ,
    "name" text  NOT NULL DEFAULT '',
    "project" text  NOT NULL ,
    "updatedAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00',
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."Variation" (
    "additionalData" text   ,
    "browserName" text  NOT NULL DEFAULT '',
    "createdAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00',
    "deviceName" text  NOT NULL DEFAULT '',
    "id" text  NOT NULL ,
    "test" text  NOT NULL ,
    "updatedAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00',
    PRIMARY KEY ("id")
) 

CREATE TABLE "public"."TestSession" (
    "autoBaseline" boolean  NOT NULL DEFAULT false,
    "baselineRef" text   ,
    "createdAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00',
    "diffImageKey" text   ,
    "id" text  NOT NULL ,
    "imageKey" text   ,
    "isSameDimensions" boolean   ,
    "misMatchPercentage" Decimal(65,30)   ,
    "misMatchTolerance" Decimal(65,30)  NOT NULL DEFAULT 0,
    "state" "TestSessionState" NOT NULL DEFAULT 'PENDING',
    "stateChangedByUser" text   ,
    "stateComment" text   ,
    "updatedAt" timestamp(3)  NOT NULL DEFAULT '1970-01-01 00:00:00',
    "variation" text  NOT NULL ,
    PRIMARY KEY ("id")
) 

CREATE UNIQUE INDEX "User.email" ON "public"."User"("email")

CREATE UNIQUE INDEX "User.apiKey" ON "public"."User"("apiKey")

CREATE UNIQUE INDEX "TestSession_baselineRef" ON "public"."TestSession"("baselineRef")

ALTER TABLE "public"."Test" ADD FOREIGN KEY ("project")REFERENCES "public"."Project"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."Variation" ADD FOREIGN KEY ("test")REFERENCES "public"."Test"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."TestSession" ADD FOREIGN KEY ("stateChangedByUser")REFERENCES "public"."User"("id") ON DELETE SET NULL  ON UPDATE CASCADE

ALTER TABLE "public"."TestSession" ADD FOREIGN KEY ("variation")REFERENCES "public"."Variation"("id") ON DELETE CASCADE  ON UPDATE CASCADE

ALTER TABLE "public"."TestSession" ADD FOREIGN KEY ("baselineRef")REFERENCES "public"."Variation"("id") ON DELETE SET NULL  ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration ..20200407161441-init
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,86 @@
+// SQLite / Mysql / Postgres
+datasource db {
+  // https://github.com/prisma/prisma2/blob/master/docs/core/connectors
+  // mysql | sqlite | postgresql
+  provider = "postgresql"
+  url      = env("VK_DATABASE")
+}
+
+generator photon {
+  provider     = "prisma-client-js"
+  binaryTarget = ["native", "linux-glibc-libssl1.0.2"]
+  output       = "../../node_modules/@generated/photonjs"
+}
+
+model User {
+  id        String   @id @default(cuid())
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+  email    String  @unique
+  password String
+  lastname String?
+  forename String?
+  active   Boolean @default(false)
+  role     Role    @default(CUSTOMER)
+  apiKey   String  @unique
+}
+
+model Project {
+  id        String   @id @default(cuid())
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+  name        String
+  description String?
+  tests       Test[]
+}
+
+model Test {
+  id        String   @id @default(cuid())
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+  name       String
+  project    Project
+  variations Variation[]
+}
+
+model Variation {
+  id        String   @id @default(cuid())
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+  browserName String
+  deviceName  String
+  test        Test
+  testSessions   TestSession[]
+  additionalData String?
+  baseline       TestSession?  @relation(name: "VariationBaseline")
+}
+
+model TestSession {
+  id        String   @id @default(cuid())
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+  diffImageKey       String?
+  imageKey           String?
+  misMatchPercentage Float?
+  misMatchTolerance  Float
+  isSameDimensions   Boolean?
+  variation          Variation
+  state              TestSessionState @default(PENDING)
+  stateChangedByUser User?
+  stateComment       String?
+  autoBaseline       Boolean          @default(false)
+  // baseline reference
+  baselineRef Variation? @relation(name: "VariationBaseline")
+}
+
+enum Role {
+  CUSTOMER
+  ADMIN
+}
+
+enum TestSessionState {
+  PENDING
+  UNRESOLVED
+  ACCEPTED
+  DECLINED
+}
```


