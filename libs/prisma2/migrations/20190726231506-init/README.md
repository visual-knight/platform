# Migration `20190726231506-init`

This migration has been generated by Mitko Tschimev at 7/26/2019, 11:15:06 PM.
You can check out the [state of the datamodel](./datamodel.prisma) after the migration.

## Database Steps

```sql
CREATE TABLE "public"."User"("id" integer NOT NULL DEFAULT 0 ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"email" text NOT NULL DEFAULT '' ,"password" text NOT NULL DEFAULT '' ,"lastname" text   ,"forename" text   ,"active" boolean NOT NULL DEFAULT false ,"role" text NOT NULL DEFAULT 'CUSTOMER' ,"apiKey" text NOT NULL DEFAULT '' ,PRIMARY KEY ("id"));

CREATE TABLE "public"."Project"("id" integer NOT NULL DEFAULT 0 ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"name" text NOT NULL DEFAULT '' ,"description" text   ,PRIMARY KEY ("id"));

CREATE TABLE "public"."Test"("id" integer NOT NULL DEFAULT 0 ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"name" text NOT NULL DEFAULT '' ,PRIMARY KEY ("id"));

CREATE TABLE "public"."Variation"("id" integer NOT NULL DEFAULT 0 ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"browserName" text NOT NULL DEFAULT '' ,"deviceName" text NOT NULL DEFAULT '' ,"additionalData" text   ,PRIMARY KEY ("id"));

CREATE TABLE "public"."TestSession"("id" integer NOT NULL DEFAULT 0 ,"createdAt" timestamp(3) NOT NULL  ,"updatedAt" timestamp(3) NOT NULL DEFAULT '1970-01-01 00:00:00' ,"diffImageKey" text   ,"imageKey" text   ,"misMatchPercentage" Decimal(65,30)   ,"misMatchTolerance" Decimal(65,30) NOT NULL DEFAULT 0 ,"isSameDimensions" boolean   ,"state" text NOT NULL DEFAULT 'PENDING' ,"stateComment" text   ,"autoBaseline" boolean NOT NULL DEFAULT false ,PRIMARY KEY ("id"));

CREATE TABLE "public"."_ProjectToUser"("A" integer NOT NULL  REFERENCES "public"."Project"("id"),"B" integer NOT NULL  REFERENCES "public"."User"("id"));

ALTER TABLE "public"."Test" ADD COLUMN "project" integer NOT NULL  REFERENCES "public"."Project"("id");

ALTER TABLE "public"."Variation" ADD COLUMN "test" integer NOT NULL  REFERENCES "public"."Test"("id"),ADD COLUMN "baseline" integer   REFERENCES "public"."TestSession"("id");

ALTER TABLE "public"."TestSession" ADD COLUMN "stateChangedByUser" integer   REFERENCES "public"."User"("id"),ADD COLUMN "variation" integer NOT NULL  REFERENCES "public"."Variation"("id");

CREATE UNIQUE INDEX "User.email._UNIQUE" ON "public"."User"("email")

CREATE UNIQUE INDEX "User.apiKey._UNIQUE" ON "public"."User"("apiKey")
```

## Changes

```diff
diff --git datamodel.mdl datamodel.mdl
migration ..20190726231506-init
--- datamodel.dml
+++ datamodel.dml
@@ -1,0 +1,100 @@
+datasource db {
+  provider = "postgresql"
+  url      = env("VK_POSTGRES_URL")
+}
+
+// datasource db {
+//   provider = "sqlite"
+//   url      = "file:dev.db"
+//   default  = true
+// }
+
+generator photon {
+  provider = "photonjs"
+}
+
+generator nexus_prisma {
+  provider = "nexus-prisma"
+  output   = "node_modules/@generated/nexus-prisma"
+}
+
+model User {
+  id        Int      @id
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+
+  email    String    @unique
+  password String
+  lastname String?
+  forename String?
+  active   Boolean   @default(false)
+  role     Role      @default(CUSTOMER)
+  projects Project[]
+  apiKey   String    @unique
+}
+
+model Project {
+  id        Int      @id
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+
+  name        String
+  description String?
+  tests       Test[]
+  users       User[]
+}
+
+model Test {
+  id        Int      @id
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+
+  name       String
+  project    Project
+  variations Variation[]
+}
+
+model Variation {
+  id        Int      @id
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+
+  browserName String
+  deviceName  String
+  test        Test
+
+  testSessions   TestSession[]
+  additionalData String?
+  baseline       TestSession?  @relation(name: "VariationBaseline")
+}
+
+model TestSession {
+  id        Int      @id
+  createdAt DateTime @default(now())
+  updatedAt DateTime @updatedAt
+
+  diffImageKey       String?
+  imageKey           String?
+  misMatchPercentage Float?
+  misMatchTolerance  Float
+  isSameDimensions   Boolean?
+  variation          Variation
+  state              TestSessionState @default(PENDING)
+  stateChangedByUser User?
+  stateComment       String?
+  autoBaseline       Boolean          @default(false)
+
+  baselineRef Variation? @relation(name: "VariationBaseline")
+}
+
+enum Role {
+  CUSTOMER
+  ADMIN
+}
+
+enum TestSessionState {
+  PENDING
+  UNRESOLVED
+  ACCEPTED
+  DECLINED
+}
```

## Photon Usage

You can use a specific Photon built for this migration (20190726231506-init)
in your `before` or `after` migration script like this:

```ts
import Photon from '@generated/photon/20190726231506-init'

const photon = new Photon()

async function main() {
  const result = await photon.users()
  console.dir(result, { depth: null })
}

main()

```
